; Fixes repairing on enemy naval yard and repairing on the move
; Taken from AlexB's Arda, with AlexB's help

@HOOK 0x004BD891 _EventClass__Execute_Vessel_Repair_Fixes

%define        Event_Execute_NULL    0x004BDFED

_EventClass__Execute_Vessel_Repair_Fixes:
    cmp  BYTE [SessionClass__Session], 0
    jz   .Apply_Fix

    cmp  BYTE [SessionClass__Session], 5
    jz   .Apply_Fix

    cmp  BYTE [fixnavalexploits], 1
    jz   .Apply_Fix

.Normal_Code:
    cmp  byte [esi+9], 2
    jnz  Event_Execute_NULL ; jumptable 004BD12D cases 6,21,22,24
    jmp  0x004BD89B

.Apply_Fix:
    Save_Registers

    cmp  byte [esi+9], 2
    jnz  .Fix_Event_Execute_NULL

    mov  eax, [ebp-0x24]


    ; Get HouseType of vessel to be repaired
    mov  edx, [eax+0x93]

    mov  eax, [ebp-0x28]

    cmp  eax, 0 ; check for null pointer
    jz   .Null_Pointer

    ; Get HouseClass of building to repair the vessel
    mov  eax, [eax+0x93]
    call 0x004D2CB0 ; HouseClass * HouseClass::As_Pointer(HousesType) proc near

    ; Check alliance
    call 0x004D5FC8     ; int const HouseClass::Is_Ally(HousesType)

    cmp  eax, 0
    jz   .Fix_Event_Execute_NULL

    jmp  .Do_Repairs

.Fix_Event_Execute_NULL:
    mov  eax, [ebp-0x24] ; unit being repaired

    mov  dl, [eax+160h]  ; eax+160h is related to repair on the move fix
    and  dl, 0FEh
    mov  [eax+160h], dl

    mov  dl, [eax+160h]  ; eax+160h is related to repair on the move fix
    and  dl, 0FDh
    mov  [eax+160h], dl
    Restore_Registers
    jmp  Event_Execute_NULL

.Do_Repairs:
    Restore_Registers
    jmp  0x004BD89B

.Null_Pointer:
    Restore_Registers
    jmp  0x004BD89B ; null pointe gets checked around here too, use that code
